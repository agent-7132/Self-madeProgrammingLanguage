
# 阶段1：构建环境
FROM nvidia/cuda:12.2.0-base-ubuntu22.04 as builder

RUN groupadd -r quantum && useradd -r -g quantum quantum

RUN apt-get update && apt-get install -y --no-install-recommends \
    wget \
    gnupg \
    software-properties-common \
    build-essential \
    cmake \
    git \
    cuda-toolkit-12-2 \
    nvidia-driver-535 \
    libcudnn8 \
    libavx512-dev \
    gcc-12-plugin-dev \
    valgrind \
    python3.10-dev \
    && wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key --keyring /etc/apt/trusted.gpg.d/llvm.gpg add - \
    && echo "deb signed-by=/etc/apt/trusted.gpg.d/llvm.gpg http://apt.llvm.org/jammy/ llvm-toolchain-jammy-18 main" >> /etc/apt/sources.list.d/llvm.list \
    && apt-get update && apt-get install -y \
    clang-18 \
    llvm-18 \
    qiskit-symbex \
    qsharp \
    libdilithium3 \
    libopenblas-dev \
    openmpi-bin libopenmpi-dev \
    intel-mkl-2023.2 \
    cython \
    onnxruntime \
    locust \
    prometheus \
    hwloc \
    numactl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

RUN git clone https://github.com/quantum-math/cholesky-cuda \
    && cd cholesky-cuda && mkdir build && cd build \
    && cmake -DCMAKE_INSTALL_PREFIX=/opt/quantum .. \
    && make install

# 阶段2：生产镜像
FROM nvidia/cuda:12.2.0-runtime-ubuntu22.04

RUN groupadd -r quantum && useradd -r -g quantum quantum \
    && mkdir -p /opt/quantum/bin /var/quantum/data \
    && chown -R quantum:quantum /opt/quantum /var/quantum

COPY --from=builder --chown=quantum:quantum /opt/quantum /opt/quantum
COPY --chown=quantum:quantum . /phase4

USER quantum
WORKDIR /var/quantum/data

ENV PYTHONUNBUFFERED=1
ENV QISKIT_IBM_TOKEN="YOUR_API_TOKEN"
ENV QSHARP_PACKAGES="/opt/qsharp-packages"
ENV LD_LIBRARY_PATH="/opt/intel/mkl/lib/intel64:/usr/local/cuda-12.2/lib64:$LD_LIBRARY_PATH"
ENV OMP_NUM_THREADS=1
ENV PATH="/usr/local/cuda-12.2/bin:/opt/quantum/bin:$PATH"
ENV CFLAGS='-march=native -O3 -mavx512f -mfma -mavx512cd'
ENV PYTHONPATH="/phase4/math:$PYTHONPATH"

HEALTHCHECK --interval=30s --timeout=10s \
    CMD curl -f http://localhost:8080/health || exit 1

CMD ["/bin/bash"]
